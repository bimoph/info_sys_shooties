{% load currency_filters %}
<style>
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .menu-button {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: #f9f9f9;
        min-width: 150px;
        z-index: 1;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .dropdown-content button {
        width: 100%;
        padding: 10px;
        text-align: left;
        background: white;
        border: none;
        cursor: pointer;
    }

    .dropdown-content button:hover {
        background-color: #f0f0f0;
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }
</style>
<thead>
    <tr>
        <th>
            {% if table_type == "pending" %}Created At
            {% elif table_type == "ready" %}Ready At
            {% elif table_type == "served" %}Served At
            {% endif %}
        </th>
        <th>Name</th>
        <th>Phone</th>
        <th>Total</th>
        <th>Menu</th>
        <th>Actions</th>
    </tr>
</thead>
<tbody>
    {% for order in orders %}
    <tr data-order-id="{{ order.id }}">
        <td>
            {% if table_type == "pending" %}{{ order.created_at|date:"Y-m-d H:i" }}
            {% elif table_type == "ready" %}{{ order.ready_at|date:"Y-m-d H:i" }}
            {% elif table_type == "served" %}{{ order.served_at|date:"Y-m-d H:i" }}
            {% endif %}
        </td>
        <td>{{ order.name }}</td>
        <td>{{ order.phone_number }}</td>
        <td>{{ order.total_price|rupiah }}</td>
        <td>
            <ul>
                {% for item in order.orderitem_set.all %}
                <li>{{ item.smoothie.name }} - {{ item.quantity }}</li>
                {% endfor %}
            </ul>
        </td>
        <td>
            {% if table_type == "pending" %}
            <button class="btn-ready" data-id="{{ order.id }}">‚úÖ Ready</button>
            <button class="btn-served" data-id="{{ order.id }}">üçΩÔ∏è Served</button>
            {% elif table_type == "ready" %}
            <button class="btn-served" data-id="{{ order.id }}">üçΩÔ∏è Served</button>
            {% endif %}

            <div class="dropdown">
                <button class="menu-button">‚ãØ</button>
                <div class="dropdown-content">
                    <button class="btn-delete" data-id="{{ order.id }}">üóëÔ∏è Delete</button>
                    {% if table_type == "ready" %}
                    <button class="btn-move-to-pending" data-id="{{ order.id }}">‚Ü©Ô∏è Back to Pending</button>
                    {% elif table_type == "served" %}
                    <button class="btn-move-to-ready" data-id="{{ order.id }}">‚Ü©Ô∏è Back to Ready</button>
                    <button class="btn-move-to-pending" data-id="{{ order.id }}">‚Ü©Ô∏è Back to Pending</button>
                    {% endif %}
                </div>
            </div>
        </td>
    </tr>
    {% endfor %}
</tbody>

<script>
    const csrfToken = '{{ csrf_token }}';

    async function postAction(url) {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        });
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to update order');
        }
    }

    document.querySelectorAll('.btn-ready').forEach(btn =>
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            postAction(`/sales/mark-ready/${id}/`);
        })
    );

    document.querySelectorAll('.btn-served').forEach(btn =>
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            postAction(`/sales/mark-served/${id}/`);
        })
    );

    document.querySelectorAll('.btn-delete').forEach(btn =>
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            if (confirm('Are you sure you want to delete this order?')) {
                postAction(`/sales/delete-order/${id}/`);
            }
        })
    );

    document.querySelectorAll('.btn-move-to-pending').forEach(btn =>
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            postAction(`/sales/move-to-pending/${id}/`);
        })
    );

    document.querySelectorAll('.btn-move-to-ready').forEach(btn =>
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            postAction(`/sales/move-to-ready/${id}/`);
        })
    );
</script>
