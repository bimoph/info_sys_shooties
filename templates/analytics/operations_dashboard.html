{% extends 'base.html' %}

{% block title %}Operations Dashboard{% endblock %}

{% block extra_css %}
<style>
  .page-container {
    max-width: 960px;
    margin: 40px auto 60px;
    padding: 0 20px;
    font-family: Arial, sans-serif;
  }
  h2, h3, h4 {
    color: #222;
  }

  /* Filters form - grid layout */
  form.filters {
    background: #fff;
    padding: 20px 24px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
    margin-bottom: 30px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px 24px;
    align-items: center;
  }
  form.filters fieldset {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px 16px;
    grid-column: span 2;
  }
  form.filters fieldset legend {
    font-weight: 600;
  }
  form.filters label {
    margin-right: 14px;
    font-weight: 500;
    cursor: pointer;
  }
  form.filters input[type="date"],
  form.filters select {
    width: 100%;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  form.filters button, form.filters a {
    display: inline-block;
    padding: 10px 28px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    text-align: center;
    text-decoration: none;
  }
  form.filters button {
    background-color: #007bff;
    color: white;
  }
  form.filters button:hover {
    background-color: #0056b3;
  }
  form.filters a {
    background-color: #6c757d;
    color: white;
  }
  form.filters a:hover {
    background-color: #565e64;
  }

  /* KPI cards in flex grid */
  .kpi-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 24px;
  }
  .kpi {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 18px 22px;
    flex: 1 1 260px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.08);
  }
  .kpi h4 {
    margin-bottom: 10px;
    font-weight: 700;
    color: #444;
  }
  .kpi div {
    font-size: 20px;
    font-weight: 700;
    color: #222;
  }
  .small {
    font-size: 0.9rem;
    color: #666;
    margin-top: 4px;
  }

  /* Stock ingredient cards grid */
  .ingredient-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 18px;
    margin-top: 16px;
  }
  .ing-card {
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 14px 16px;
    text-align: center;
    box-shadow: 0 1px 4px rgb(0 0 0 / 0.07);
  }
  .ing-card strong {
    font-size: 1.1rem;
    color: #333;
  }
  .ing-card div {
    margin-top: 8px;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-container" role="main" aria-label="Operations Dashboard">

  <div class="page-container" role="main" aria-labelledby="page-title" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
    <h2 id="page-title">Operations Dashboard</h2>
    <a href="{% url 'analytics_dashboard' %}" class="btn btn-primary" style="white-space: nowrap; font-weight: 600; padding: 8px 18px;">Sales Dashboard -></a>
  </div>

  

  <form method="get" class="filters" aria-label="Filter operations data">
    <label for="store">Store:</label>
        <select name="store" id="store">
            <option value="">-- All Stores --</option>
            {% for s in stores %}
            <option value="{{ s.id }}"
                {% if request.GET.store|default_if_none:""|stringformat:"s" == s.id|stringformat:"s" %}selected{% endif %}>
                {{ s.name }}
            </option>
            {% endfor %}
    </select>
    <label for="start_date">Start Date:
      <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
    </label>

    <label for="end_date">End Date:
      <input type="date" id="end_date" name="end_date" value="{{ end_date }}">
    </label>

    <fieldset>
      <legend>Filter by Menu</legend>
      {% for menu in menus %}
      <label>
        <input type="checkbox" name="menu" value="{{ menu.id }}"
          {% if menu.id|stringformat:"s" in selected_menus %}checked{% endif %}>
        {{ menu.name }}
      </label>
      {% endfor %}
    </fieldset>

    <label for="time_division">Time Division:
      <select id="time_division" name="time_division">
        <option value="" {% if not time_division_selected %}selected{% endif %}>-- All --</option>
        <option value="morning" {% if time_division_selected == "morning" %}selected{% endif %}>Morning (09-11)</option>
        <option value="lunch" {% if time_division_selected == "lunch" %}selected{% endif %}>Lunch (11-13)</option>
        <option value="after_lunch" {% if time_division_selected == "after_lunch" %}selected{% endif %}>After Lunch (13-15)</option>
        <option value="afternoon" {% if time_division_selected == "afternoon" %}selected{% endif %}>Afternoon (15-18)</option>
      </select>
    </label>

    <button type="submit" aria-label="Apply filters">Apply</button>
    <a href="{% url 'operations_dashboard' %}" role="button">Reset</a>
  </form>

  <div class="kpi-row" role="region" aria-label="Key performance indicators">
    <div class="kpi">
      <h4>Avg — Ready time</h4>
      <div>{{ avg_ready_display }}</div>
      <small class="small">Avg time between order created → ready</small>
    </div>

    <div class="kpi">
      <h4>Avg — Served time from Ready</h4>
      <div>{{ avg_served_from_ready_display }}</div>
      <small class="small">Avg time between ready → served</small>
    </div>

    <div class="kpi">
      <h4>Avg — Served time from Created</h4>
      <div>{{ avg_served_from_created_display }}</div>
      <small class="small">Avg time between order created → served</small>
    </div>
  </div>

  <section style="max-width:700px; margin-bottom: 24px;" aria-label="Durations bar chart">
    <h4>Durations (minutes) — visual</h4>
    <canvas id="durationsChart" role="img" aria-describedby="durationsChartDesc"></canvas>
    <p id="durationsChartDesc" class="visually-hidden">Bar chart showing average durations in minutes.</p>
  </section>

  <form method="get" aria-label="Stock snapshot date selection" style="margin-bottom: 12px;">
    <label for="stock_date">Stock Snapshot Date:</label>
    <input type="date" id="stock_date" name="stock_date" value="{{ stock_date }}">
    <button type="submit">Show Snapshot</button>
  </form>

  <h3>Stock at {{ stock_date|default:"today" }} — snapshot at 23:00 (Jakarta)</h3>
  <div class="ingredient-grid" role="list">
    {% for card in ingredient_cards %}
      <article class="ing-card" role="listitem">
        <strong>{{ card.name }}</strong>
        <div style="font-size:20px; margin-top:6px;">{{ card.stock_at_snapshot }} {{ card.unit }}</div>
        <div class="small" style="margin-top:6px;">Stock at selected day 23:00 (Jakarta)</div>
      </article>
    {% endfor %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const durationLabels = {{ duration_chart_labels|safe }};
    const durationValues = {{ duration_chart_values|safe }};

    new Chart(document.getElementById('durationsChart'), {
      type: 'bar',
      data: {
        labels: durationLabels,
        datasets: [{
          label: 'Avg minutes',
          data: durationValues,
          backgroundColor: ['#4BC0C0','#36A2EB','#FFCE56']
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero:true
          }
        }
      }
    });
  </script>
</div>
{% endblock %}
